---
    name: Continuous Deployment
    
    on:
      push:
        # Run workflow every time something is pushed to the main branch
        branches:
          - main
          - master
          - refactor/*
          - feature/*
          - bugfix/*
      # allow manual triggers for now too
      workflow_dispatch:
        manual: true
    
    # Remember to set the following secrets in your repository's settings:
    # https://github.com/your_username/itu-minitwit-ci/settings/secrets/actions
    # DOCKER_USERNAME
    # DOCKER_PASSWORD
    # SSH_USER
    # SSH_KEY
    # SSH_HOST
    
    jobs:
      build:
        runs-on: ubuntu-latest
    
        steps:
          - name: Checkout
            uses: actions/checkout@v2
    
          - name: Login to Docker Hub
            uses: docker/login-action@v3
            with:
              username: ${{ secrets.DOCKER_USERNAME }}
              password: ${{ secrets.DOCKER_PASSWORD }}
    
          - name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v3
    
          - name: Build and push minitwit-app
            uses: docker/build-push-action@v6
            with:
              context: .
              file: ./Dockerfile-minitwit
              push: true
              tags: ${{ secrets.DOCKER_USERNAME }}/minitwit-app:latest
              cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/minitwit-app:webbuildcache
              cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/minitwit-app:webbuildcache,mode=max

          - name: Build and push minitwit-api
            uses: docker/build-push-action@v6
            with:
                context: .
                file: ./Dockerfile-minitwit
                push: true
                tags: ${{ secrets.DOCKER_USERNAME }}/minitwit-api:latest
                cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/minitwit-api:webbuildcache
                cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/minitwit-api:webbuildcache,mode=max


          - name: Configure SSH
            run: |
              mkdir -p ~/.ssh/
              echo "${{ secrets.ACTIONS_SSH_PRIVATE }}" > ~/.ssh/do_ssh_key
              chmod 600 ~/.ssh/do_ssh_key
              ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
            env:
              SSH_KEY: ${{ secrets.ACTIONS_SSH_PRIVATE }}
    
          - name: Deploy to server
            # Configure the ~./bash_profile and deploy.sh file on the Vagrantfile
            run: >
              ssh $SSH_USER@$SSH_HOST
              -i ~/.ssh/do_ssh_key -o StrictHostKeyChecking=no
              '/minitwit/deploy.sh'
            env:
              SSH_USER: ${{ secrets.SSH_USER }}
              SSH_HOST: ${{ secrets.SSH_HOST }}